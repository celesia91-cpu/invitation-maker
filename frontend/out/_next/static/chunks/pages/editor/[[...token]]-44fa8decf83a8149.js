(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[348],{4774:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/editor/[[...token]]",function(){return n(958)}])},958:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return R}});var l=n(5893),i=n(1163),r=n(7294),s=n(2281);let d=(0,r.createContext)(null),o=(0,r.createContext)(null),a={slideId:null,elementId:null},u={width:1080,height:1920,scale:1},c={showGrid:!1,snapToGrid:!0,showAuthModal:!1,showShareModal:!1},h="slide_";function f(e,t){if("string"!=typeof e||!e.startsWith(t))return 0;let n=Number.parseInt(e.slice(t.length),10);return Number.isFinite(n)?n:0}function p(e){var t;let n={current:0},l={current:0};return(null==e?void 0:null===(t=e.slides)||void 0===t?void 0:t.length)&&e.slides.forEach(e=>{n.current=Math.max(n.current,f(e.id,h)),Array.isArray(e.elements)&&e.elements.forEach(e=>{l.current=Math.max(l.current,f(e.id,"el_"))})}),{slideIdCounter:n,elementIdCounter:l,nextSlideId:()=>(n.current+=1,"".concat(h).concat(n.current)),nextElementId:()=>(l.current+=1,"".concat("el_").concat(l.current))}}let m=e=>({id:e.nextSlideId(),name:"Slide 1",elements:[]});function x(e,t){let{slides:n,selected:l,viewport:i,ui:r,...s}=null!=t?t:{};return{slides:null!=n?n:[m(e)],selected:null!=l?l:{...a},viewport:null!=i?i:{...u},ui:null!=r?r:{...c},...s}}function v(e,t){var n;let{slideId:l}=e.selected,i=null!=l?l:null===(n=e.slides[0])||void 0===n?void 0:n.id;if(!i)return e;let r=e.slides.map(e=>e.id===i?t(e):e);return{...e,slides:r}}function g(e){return function(t,n){var l,i,r,s,d,o,a,u,c,h,f,p,m;switch(n.type){case"ADD_SLIDE":{let n=t.slides.length+1,l={id:e.nextSlideId(),name:"Slide ".concat(n),elements:[]};return{...t,slides:[...t.slides,l],selected:{slideId:l.id,elementId:null}}}case"RENAME_SLIDE":{let{slideId:e,name:l}=n,i=t.slides.map(t=>t.id===e?{...t,name:l}:t);return{...t,slides:i}}case"REMOVE_SLIDE":{let{slideId:e}=n,r=t.slides.filter(t=>t.id!==e),s=null!==(i=null===(l=r[0])||void 0===l?void 0:l.id)&&void 0!==i?i:null;return{...t,slides:r,selected:{slideId:s,elementId:null}}}case"SELECT_SLIDE":return{...t,selected:{slideId:n.slideId,elementId:null}};case"ADD_TEXT":{let l={id:e.nextElementId(),type:"text",x:null!==(r=n.x)&&void 0!==r?r:100,y:null!==(s=n.y)&&void 0!==s?s:100,width:null!==(d=n.width)&&void 0!==d?d:400,height:null!==(o=n.height)&&void 0!==o?o:80,rotation:0,content:null!==(a=n.content)&&void 0!==a?a:"Edit me",style:{color:"#111",fontFamily:"Arial, sans-serif",fontSize:48,fontWeight:600,textAlign:"center"}};return v(t,e=>({...e,elements:[...e.elements,l]}))}case"UPDATE_TEXT":{let{elementId:e,patch:l}=n;return v(t,t=>({...t,elements:t.elements.map(t=>t.id===e?{...t,...l,style:{...t.style,...l.style||{}}}:t)}))}case"ADD_IMAGE":{let l={id:e.nextElementId(),type:"image",x:null!==(u=n.x)&&void 0!==u?u:100,y:null!==(c=n.y)&&void 0!==c?c:100,width:null!==(h=n.width)&&void 0!==h?h:400,height:null!==(f=n.height)&&void 0!==f?f:300,rotation:0,src:null!==(p=n.src)&&void 0!==p?p:"",fit:null!==(m=n.fit)&&void 0!==m?m:"cover"};return v(t,e=>({...e,elements:[...e.elements,l]}))}case"UPDATE_IMAGE":{let{elementId:e,patch:l}=n;return v(t,t=>({...t,elements:t.elements.map(t=>t.id===e?{...t,...l}:t)}))}case"SELECT_ELEMENT":return{...t,selected:{...t.selected,elementId:n.elementId}};case"MOVE_ELEMENT":{let{elementId:e,x:l,y:i}=n;return v(t,t=>({...t,elements:t.elements.map(t=>t.id===e?{...t,x:l,y:i}:t)}))}case"RESIZE_ELEMENT":{let{elementId:e,width:l,height:i}=n;return v(t,t=>({...t,elements:t.elements.map(t=>t.id===e?{...t,width:l,height:i}:t)}))}case"DELETE_ELEMENT":{let{elementId:e}=n;return v(t,t=>({...t,elements:t.elements.filter(t=>t.id!==e)}))}case"SET_VIEWPORT":{let{width:e,height:l,scale:i}=n;return{...t,viewport:{width:e,height:l,scale:null!=i?i:t.viewport.scale}}}case"SET_SCALE":return{...t,viewport:{...t.viewport,scale:n.scale}};case"TOGGLE_MODAL":{let{key:e,value:l}=n;return{...t,ui:{...t.ui,[e]:null!=l?l:!t.ui[e]}}}default:return t}}}x(p());let y={latestCounters:null,setLatestCounters(e){y.latestCounters=e},getLatestCounters(){let e=y.latestCounters;return e?{slideIdCounter:e.slideIdCounter.current,elementIdCounter:e.elementIdCounter.current}:{slideIdCounter:0,elementIdCounter:0}},createHarness(e){let t=p(e);return{counters:t,initialState:x(t,e),reducer:g(t)}}};function E(e){let{children:t,initial:n}=e,i=(0,r.useRef)(null);i.current||(i.current=p(n));let s=(0,r.useMemo)(()=>g(i.current),[i]),[a,u]=(0,r.useReducer)(s,void 0,()=>x(i.current,n)),c=(0,r.useMemo)(()=>a,[a]),h=(0,r.useMemo)(()=>u,[u]);return y.setLatestCounters(i.current),(0,l.jsx)(d.Provider,{value:c,children:(0,l.jsx)(o.Provider,{value:h,children:t})})}function j(){let e=(0,r.useContext)(d);if(!e)throw Error("useEditorState must be used within EditorProvider");return e}var b=n(6177),w=n(4197);function C(e){let{roleCapabilities:t}=e,[n,i]=[j(),function(){let e=(0,r.useContext)(o);if(!e)throw Error("useEditorDispatch must be used within EditorProvider");return e}()],{slides:s,selected:d}=n,{userRole:a}=(0,b.mr)(),{canEdit:u}=(0,r.useMemo)(()=>{let e=(0,w.NP)(a);return t&&"object"==typeof t?(0,w.dU)(t,e):(0,w.dU)({role:e},e)},[t,a]),c=!u,h=c?"Adding slides is limited to creator or admin roles.":void 0,f=(0,r.useCallback)(()=>{c||i({type:"ADD_SLIDE"})},[i,c]),p=(0,r.useCallback)(e=>{i({type:"SELECT_SLIDE",slideId:e})},[i]);return(0,l.jsxs)("div",{style:{width:240,borderRight:"1px solid #e5e7eb",display:"flex",flexDirection:"column"},children:[(0,l.jsxs)("div",{style:{padding:12,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[(0,l.jsx)("strong",{children:"Slides"}),(0,l.jsx)("button",{onClick:f,style:{padding:"4px 8px"},disabled:c,title:h,children:"+ Add"})]}),(0,l.jsx)("div",{style:{overflowY:"auto"},children:s.map((e,t)=>(0,l.jsx)("button",{onClick:()=>p(e.id),style:{width:"100%",textAlign:"left",padding:10,border:"none",borderTop:"1px solid #f3f4f6",background:d.slideId===e.id?"#eef2ff":"white",cursor:"pointer"},children:e.name||"Slide ".concat(t+1)},e.id))})]})}function S(e,t){switch(t.type){case"SET":if(e.present===t.newPresent)return e;return{past:[...e.past,e.present],present:t.newPresent,future:[]};case"UNDO":{if(0===e.past.length)return e;let t=e.past[e.past.length-1];return{past:e.past.slice(0,-1),present:t,future:[e.present,...e.future]}}case"REDO":{if(0===e.future.length)return e;let[t,...n]=e.future;return{past:[...e.past,e.present],present:t,future:n}}default:return e}}function k(e){let[t,n]=(0,r.useReducer)(S,{past:[],present:e,future:[]});return{state:t.present,set:e=>n({type:"SET",newPresent:e}),undo:()=>n({type:"UNDO"}),redo:()=>n({type:"REDO"}),canUndo:t.past.length>0,canRedo:t.future.length>0}}function I(){let e=(0,r.useRef)(!1),t=(0,r.useRef)({x:0,y:0}),{state:n,set:i,undo:s,redo:d,canUndo:o,canRedo:a}=k({x:0,y:0});return(0,l.jsxs)("div",{className:"drag-demo",children:[(0,l.jsx)("div",{className:"draggable",onPointerDown:l=>{e.current=!0,t.current={x:l.clientX-n.x,y:l.clientY-n.y}},onPointerMove:n=>{e.current&&i({x:n.clientX-t.current.x,y:n.clientY-t.current.y})},onPointerUp:()=>{e.current=!1},style:{width:100,height:100,background:"lightblue",position:"absolute",cursor:"move",transform:"translate(".concat(n.x,"px, ").concat(n.y,"px)")}}),(0,l.jsxs)("div",{className:"controls",children:[(0,l.jsx)("button",{onClick:s,disabled:!o,children:"Undo"}),(0,l.jsx)("button",{onClick:d,disabled:!a,children:"Redo"})]})]})}function T(e){let{title:t,children:n}=e,{state:i,set:r,undo:s,redo:d,canUndo:o,canRedo:a}=k(!0);return(0,l.jsxs)("div",{className:"collapsible-group",children:[(0,l.jsxs)("button",{onClick:()=>r(!i),children:[i?"Hide":"Show"," ",t]}),i&&(0,l.jsx)("div",{className:"content",children:n}),(0,l.jsxs)("div",{className:"controls",children:[(0,l.jsx)("button",{onClick:s,disabled:!o,children:"Undo"}),(0,l.jsx)("button",{onClick:d,disabled:!a,children:"Redo"})]})]})}var _=n(5675),N=n.n(_);function D(e){let{children:t}=e,{imgState:n,workSize:i}=(0,b.mr)(),s=(0,r.useMemo)(()=>{var e,t;let l=(n.flip?-1:1)*(null!==(e=n.signX)&&void 0!==e?e:1),i=null!==(t=n.signY)&&void 0!==t?t:1;return["translate(-50%,-50%)","rotate(".concat(n.angle,"rad)"),"skew(".concat(n.shearX,"rad, ").concat(n.shearY,"rad)"),"scale(".concat(n.scale*l,", ").concat(n.scale*i,")")].join(" ")},[n]);return(0,l.jsxs)("div",{id:"work",style:{position:"relative",width:i.w,height:i.h,background:"#0b0b22",borderRadius:8,overflow:"hidden"},children:[(0,l.jsx)("div",{id:"userBgWrap",style:{position:"absolute",left:n.cx,top:n.cy,width:n.natW,height:n.natH,transform:s,transformOrigin:"50% 50%"},children:n.has?(0,l.jsx)(N(),{id:"userBg",src:n.backendImageUrl||n.backendThumbnailUrl||"/placeholder.jpg",alt:"Background",fill:!0,sizes:"100vw",style:{objectFit:"contain"}}):(0,l.jsx)("div",{style:{color:"#94a3b8",fontSize:12,padding:8},children:"No image selected"})}),t]})}function M(){var e,t;let{activeIndex:n,slides:i,addTextLayer:r,updateTextLayer:s,removeTextLayer:d}=(0,b.mr)(),o=null!==(t=null===(e=i[n])||void 0===e?void 0:e.layers)&&void 0!==t?t:[];return(0,l.jsxs)("div",{className:"text-controls",children:[(0,l.jsxs)("div",{style:{display:"flex",gap:8},children:[(0,l.jsx)("input",{id:"addText",type:"text",placeholder:"Type text"}),(0,l.jsx)("button",{className:"btn",onClick:()=>{let e=document.getElementById("addText");r((null==e?void 0:e.value)||"Text"),e&&(e.value="")},children:"+ Add"})]}),(0,l.jsx)("div",{style:{marginTop:12},children:o.map((e,t)=>(0,l.jsxs)("div",{style:{display:"flex",gap:8,alignItems:"center",marginBottom:6},children:[(0,l.jsxs)("span",{style:{minWidth:80,fontSize:12,color:"#94a3b8"},children:["Layer ",t+1]}),(0,l.jsx)("input",{type:"text",value:e.text,onChange:e=>s(t,{text:e.target.value}),style:{flex:1}}),(0,l.jsx)("button",{className:"btn",onClick:()=>d(t),children:"Delete"})]},t))})]})}function L(){let{playing:e,setPlaying:t}=(0,b.mr)();return(0,l.jsxs)("div",{className:"playback-controls",style:{display:"flex",gap:8},children:[(0,l.jsx)("button",{className:"btn",onClick:()=>t(!1),children:"Prev"}),(0,l.jsx)("button",{className:"btn","aria-pressed":e,onClick:()=>t(!e),children:e?"Pause":"Play"}),(0,l.jsx)("button",{className:"btn",onClick:()=>t(!1),children:"Next"})]})}var A=n(3012);function P(){let e=(0,i.useRouter)(),t=e.query.token,n=e.query.view,{slides:d,setSlides:o,activeIndex:a,setActiveIndex:u,tokenBalance:c}=(0,b.mr)();j();let[h,f]=(0,r.useState)(!1);!function(){let{workSize:e,setWorkSize:t}=(0,b.mr)();(0,r.useEffect)(()=>{let e=()=>{let e=Math.max(320,Math.min(window.innerWidth-32,1280));t(e,Math.round(e/16*9))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[t])}();let{setCurrentDesignId:p,isDesignOwned:m,ensureOwnership:x,loading:v,error:g}=(0,A.Z)(),y=(0,r.useMemo)(()=>t?Array.isArray(t)?0===t.length?null:t[0]?String(t[0]):null:t?String(t):null:null,[t]);(0,r.useEffect)(()=>{y?(p(y),x(y).catch(()=>{})):p(null)},[y,x,p]);let E=!y||m(y),w=!!y&&!E,S=y?v?"Checking access for this design…":E?"You own this design and can edit it freely.":g?"We could not confirm ownership. Editing is locked until you purchase this design.":"Editing is locked until you purchase this design.":"Editing a custom design.";return(0,r.useEffect)(()=>{d&&0!==d.length||(o([{id:1,name:"Slide 1",image:null,layers:[{text:"First Slide",left:16,top:16,fontSize:28,fontFamily:"system-ui",color:"#ffffff"}],workSize:{w:800,h:450},durationMs:3e3},{id:2,name:"Slide 2",image:null,layers:[{text:"Second Slide",left:16,top:16,fontSize:28,fontFamily:"system-ui",color:"#ffffff"}],workSize:{w:800,h:450},durationMs:3e3}]),u(0))},[d,o,u]),(0,l.jsxs)("div",{children:["Editor",t&&(0,l.jsxs)("span",{children:[" Token: ",t]}),n&&(0,l.jsxs)("span",{children:[" View: ",n]}),(0,l.jsxs)("div",{children:["Token Balance: ",c]}),(0,l.jsx)("button",{onClick:()=>f(!0),children:"Login"}),(0,l.jsx)(s.Z,{isOpen:h,onClose:()=>f(!1)}),(0,l.jsxs)("div",{className:"editor-ownership-status",role:w?"alert":"status","aria-live":"polite","data-editing-disabled":w?"true":"false",children:[(0,l.jsx)("strong",{children:"Design Access:"})," ",S]}),(0,l.jsx)(T,{title:"Slides",children:(0,l.jsx)(C,{slides:d})}),(0,l.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"1fr 320px",gap:16,marginTop:16},children:[(0,l.jsxs)("div",{"aria-disabled":w,"data-editing-locked":w?"true":"false",style:w?{opacity:.6,pointerEvents:"none"}:void 0,children:[(0,l.jsx)(D,{}),(0,l.jsx)("div",{style:{marginTop:8},children:(0,l.jsx)(L,{})})]}),(0,l.jsx)("div",{"aria-disabled":w,"data-editing-locked":w?"true":"false",style:w?{opacity:.6,pointerEvents:"none"}:void 0,children:(0,l.jsx)(M,{})})]}),(0,l.jsx)("div",{style:{marginTop:16},children:(0,l.jsx)("div",{"aria-disabled":w,"data-editing-locked":w?"true":"false",style:w?{opacity:.6,pointerEvents:"none"}:void 0,children:(0,l.jsx)(I,{})})})]})}function R(){return(0,l.jsx)(E,{children:(0,l.jsx)(P,{})})}}},function(e){e.O(0,[675,395,888,774,179],function(){return e(e.s=4774)}),_N_E=e.O()}]);