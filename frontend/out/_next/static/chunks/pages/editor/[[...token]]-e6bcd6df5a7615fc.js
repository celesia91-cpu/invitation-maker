(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[348],{4774:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/editor/[[...token]]",function(){return s(7391)}])},7391:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return S}});var r=s(5893),n=s(1163),i=s(7294),o=s(6177);let a=[];function l(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"error",r=arguments.length>3?arguments[3]:void 0;return{level:s,message:e&&e.message?e.message:String(e),stack:e&&e.stack?e.stack:void 0,context:t,details:r,timestamp:new Date().toISOString()}}function c(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments.length>2?arguments[2]:void 0,r=l(e instanceof Error?e:Error(String(e)),t,"error",s);return a.push(r),console.error("[".concat(r.timestamp,"]").concat(t?" "+t+":":""," ").concat(r.message)),r}function u(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",s=arguments.length>2?arguments[2]:void 0,r=l(e instanceof Error?e:Error(String(e)),t,"warn",s);return a.push(r),console.warn("[".concat(r.timestamp,"]").concat(t?" "+t+":":""," ").concat(r.message)),r}class h{setupInterceptors(){"function"==typeof window.fetch?(this._originalFetch=window.fetch,this._log("API Client initialized with base URL:",this.baseURL)):(this._originalFetch=this.fetch,this._log("API Client initialized without browser environment:",this.baseURL))}_safeParse(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if("string"!=typeof e)return u("".concat(t,": expected string but received ").concat(typeof e)),s;try{return JSON.parse(e)}catch(n){let r=e.slice(0,100);return u(n,"Failed to parse ".concat(t),{snippet:r}),s}}_getSession(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._storage;try{if(!e||"function"!=typeof e.getItem)return null;let t=e.getItem(this._storageKey);if(!t)return null;if("string"!=typeof t||!t.trim().startsWith("{"))return u("Malformed session storage data"),null;let s=this._safeParse(t,"session storage");return s&&"object"==typeof s?s:null}catch(e){return u(e,"Failed to access session storage"),null}}loadToken(){try{let e=this._loadFromStorage("undefined"!=typeof localStorage?localStorage:null,this._persistentDuration);if(e)return this._storage=localStorage,this._currentDuration=this._persistentDuration,this.token=e.token,this._log("Token restored from localStorage"),e.token;let t=this._loadFromStorage("undefined"!=typeof sessionStorage?sessionStorage:null,this._sessionDuration);if(t)return this._storage=sessionStorage,this._currentDuration=this._sessionDuration,this.token=t.token,this._log("Token restored from sessionStorage"),t.token;return this.token=null,this._storage="undefined"!=typeof sessionStorage?sessionStorage:null,this._currentDuration=this._sessionDuration,null}catch(e){return u(e,"Failed to load token from storage"),null}}_loadFromStorage(e,t){if(!e)return null;let s=this._getSession(e);if(s&&"string"==typeof s.token&&"number"==typeof s.lastActivity){if(Date.now()-s.lastActivity<t)return s;try{e.removeItem(this._storageKey)}catch(e){}}return null}_selectStorage(e){e&&"undefined"!=typeof localStorage?(this._storage=localStorage,this._currentDuration=this._persistentDuration):(this._storage="undefined"!=typeof sessionStorage?sessionStorage:null,this._currentDuration=this._sessionDuration)}saveToken(e){try{if(e&&"string"==typeof e&&this._storage){let t={token:e,lastActivity:Date.now()};this._storage.setItem(this._storageKey,JSON.stringify(t));let s=this._storage===localStorage?sessionStorage:localStorage;try{s&&s.removeItem(this._storageKey)}catch(e){}this.token=e,this._log("Token saved to storage successfully")}else this.clearToken()}catch(t){u(t,"Failed to save token to storage"),this.token=e}}clearToken(){try{"undefined"!=typeof sessionStorage&&sessionStorage.removeItem(this._storageKey)}catch(e){u(e,"Failed to clear token from sessionStorage")}try{"undefined"!=typeof localStorage&&localStorage.removeItem(this._storageKey)}catch(e){u(e,"Failed to clear token from localStorage")}this.token=null,this._storage="undefined"!=typeof sessionStorage?sessionStorage:null,this._currentDuration=this._sessionDuration}saveUser(e){try{if(e&&"object"==typeof e&&this._storage){let t=this._getSession()||{};t.user=e,t.lastActivity=Date.now(),this._storage.setItem(this._storageKey,JSON.stringify(t))}}catch(e){u(e,"Failed to save user to storage")}}getUser(){try{let e=this._getSession();if(e&&"object"==typeof e.user)return e.user;return e&&u("Session user missing or invalid"),null}catch(e){return u(e,"Failed to get user from storage"),null}}isSessionValid(){try{let e=this._getSession();if(!e||"string"!=typeof e.token||"number"!=typeof e.lastActivity)return e&&u("Session missing required fields"),!1;return Date.now()-e.lastActivity<this._currentDuration}catch(e){return!1}}refreshSession(){try{if(!this.token||!this.isSessionValid()||!this._storage)return;let e=this._getSession();e?(e.lastActivity=Date.now(),this._storage.setItem(this._storageKey,JSON.stringify(e))):u("No valid session to refresh")}catch(e){u(e,"Failed to refresh session")}}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.retryRequest(async()=>{let s="".concat(this.baseURL).concat(e);this.refreshSession();let r={...t.headers||{}},n=Object.keys(r).some(e=>"content-type"===e.toLowerCase()),i="undefined"!=typeof FormData&&t.body instanceof FormData;n||i||(r["Content-Type"]="application/json");let o={headers:r,...t};this.token&&this.isSessionValid()&&!Object.keys(r).some(e=>"authorization"===e.toLowerCase())&&(r.Authorization="Bearer ".concat(this.token)),this._log("Making request:",o.method||"GET",s);try{let t;let r=await this.fetch(s,o);if((r.headers.get("content-type")||"").includes("application/json"))try{t=await r.json()}catch(e){u(e,"Failed to parse JSON response"),t={error:"Invalid server response"}}else t=await r.text();if(!r.ok){if(this._log("Request failed:",r.status,t),401===r.status&&!this.isRetrying&&(this.clearToken(),!e.includes("/auth/")))throw Error("Authentication required - please log in again");if(429===r.status)throw Error("Too many requests - please wait a moment");if(r.status>=500)throw Error("Server error - please try again later");let s="object"==typeof t?t.error:t;throw Error(s||"HTTP ".concat(r.status,": ").concat(r.statusText))}return this._log("Request successful:",t),t}catch(e){if("TypeError"===e.name&&e.message.includes("fetch"))throw Error("Network error - please check your connection");throw e}})}async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=new URLSearchParams(t).toString(),r=s?"".concat(e,"?").concat(s):e;return this.request(r,{method:"GET"})}async post(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.request(e,{method:"POST",body:JSON.stringify(t),...s})}async put(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(e,{method:"PUT",body:JSON.stringify(t)})}async delete(e){return this.request(e,{method:"DELETE"})}async getUserTokens(){return this.get("/user/tokens")}async updateTokens(e){return this.post("/purchase",{tokens:e})}async register(e){this.isRetrying=!0;try{let t=await this.post("/auth/register",e);return t.token&&this.saveToken(t.token),t.user&&this.saveUser(t.user),t}finally{this.isRetrying=!1}}async login(e){let{remember:t=!1,...s}=e;try{let e=await this.request("/auth/login",{method:"POST",body:JSON.stringify(s)});if(e.access_token||e.token){let s=e.access_token||e.token;return this._selectStorage(t),this.saveToken(s),e.user&&this.saveUser(e.user),e}throw Error("No token received from server")}catch(e){throw c(e,"Login failed"),e}}async logout(){try{if(this.isAuthenticated())try{await this.request("/auth/logout",{method:"POST"})}catch(e){u(e,"Logout endpoint failed")}}finally{this.clearToken()}}async getCurrentUser(){let e=this.getUser();if(e&&this.isSessionValid())return{user:e};let t=await this.get("/auth/me");return t.user&&this.saveUser(t.user),t}async getUserDesigns(){return this.get("/designs")}async getProjects(){return this.get("/projects")}async getProject(e){return this.get("/projects/".concat(e))}async saveProject(e){return this.post("/projects",e)}async updateProject(e,t){return this.put("/projects/".concat(e),t)}async deleteProject(e){return this.delete("/projects/".concat(e))}async uploadImage(e){if(!e)throw Error("No file provided");if(!["image/jpeg","image/jpg","image/png","image/gif","image/webp"].includes(e.type))throw Error("Invalid file type. Please upload JPEG, PNG, GIF, or WebP images.");if(e.size>10485760)throw Error("File is too large. Maximum size is 10MB.");if(!this.token||!this.isSessionValid())throw Error("Authentication required for image upload");let t=new FormData;t.append("image",e);try{return await this.request("/images/upload",{method:"POST",body:t})}catch(e){throw Error("Image upload failed: ".concat(e.message))}}async loadCustomerDesign(e){return this.get("/editor/".concat(e))}async saveCustomerDesign(e,t){return this.post("/editor/".concat(e,"/save"),t)}async getCustomerRSVPs(e){return this.get("/editor/".concat(e,"/rsvps"))}async submitRSVP(e){return this.post("/rsvp/submit",e)}isAuthenticated(){return!!(this.token&&this.isSessionValid())}handleError(e){c(e,"API Error");let t=e.message||"An unexpected error occurred.";return t.includes("Network error")?"Connection failed. Please check your internet connection.":t.includes("Authentication required")?"Please log in to continue.":t.includes("Invalid credentials")?"Invalid email or password.":t.includes("User already exists")?"An account with this email already exists.":t.includes("Too many requests")?"Too many requests. Please wait a moment before trying again.":t.includes("File is too large")?"File is too large. Maximum size is 10MB.":t.includes("Invalid file type")?"Please upload a valid image file (JPEG, PNG, GIF, or WebP).":t.includes("Server error")?"Server temporarily unavailable. Please try again later.":t}async retryRequest(e){let t,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e3;for(let n=0;n<s;n++)try{return await e()}catch(i){t=i;let e=i.message||"";if(e.includes("Authentication")||e.includes("Invalid")||e.includes("Too many requests")||e.includes("unauthorized"))throw i;if(n<s-1){let e=r*Math.pow(2,n);await new Promise(t=>setTimeout(t,e))}}throw t}async uploadImages(e){let t=Array.from(e).map(e=>this.uploadImage(e));try{return await Promise.all(t)}catch(e){throw Error("Failed to upload images: ".concat(e.message))}}setBaseURL(e){this.baseURL=e,this._log("Base URL updated to:",e)}getBaseURL(){return this.baseURL}async healthCheck(){let e=new AbortController,t=setTimeout(()=>e.abort(),5e3);try{let s=await this.request("/health",{signal:e.signal});return clearTimeout(t),s}catch(e){if(clearTimeout(t),"AbortError"===e.name)throw Error("Health check timed out");throw Error("Backend server is not responding")}}debug(){let e=!(arguments.length>0)||void 0===arguments[0]||arguments[0];this._debug=e,e&&(console.log("API Client Debug Mode Enabled"),console.log("Base URL:",this.baseURL),console.log("Token:",this.token?"Present":"Not set"),console.log("Session Valid:",this.isSessionValid()))}_log(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];this._debug&&console.log("[API Client]",...t)}constructor(e,t){e||(e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:3001/api":"https://invitation-maker-api.celesia91.workers.dev/api"),"function"==typeof window.fetch?this.fetch=window.fetch.bind(window):this.fetch=t||("undefined"!=typeof globalThis&&"function"==typeof globalThis.fetch?globalThis.fetch.bind(globalThis):void 0),this.baseURL=e,this._storageKey="app_auth_session",this._sessionDuration=864e5,this._persistentDuration=6048e5,this._storage="undefined"!=typeof sessionStorage?sessionStorage:null,this._currentDuration=this._sessionDuration,this.token=this.loadToken(),this.setupInterceptors(),this.isRetrying=!1,this._debug=!1}}function d(e){let{isOpen:t,onClose:s}=e,{setTokenBalance:n}=(0,o.m)(),a=(0,i.useMemo)(()=>new h,[]),[l,c]=(0,i.useState)(""),[u,d]=(0,i.useState)(""),[g,f]=(0,i.useState)(!1),[p,y]=(0,i.useState)(null),[m,v]=(0,i.useState)(!1);if(!t)return null;let S=async e=>{e.preventDefault(),v(!0),y(null);try{let e=await a.login({email:l,password:u,remember:g});n(e.balance||0),null==s||s()}catch(e){y(e.message||"Login failed")}finally{v(!1)}};return(0,r.jsx)("div",{className:"modal-backdrop",children:(0,r.jsx)("div",{className:"modal",children:(0,r.jsxs)("form",{onSubmit:S,children:[(0,r.jsx)("h2",{children:"Login"}),(0,r.jsxs)("label",{children:["Email",(0,r.jsx)("input",{type:"email",value:l,onChange:e=>c(e.target.value)})]}),(0,r.jsxs)("label",{children:["Password",(0,r.jsx)("input",{type:"password",value:u,onChange:e=>d(e.target.value)})]}),(0,r.jsxs)("label",{children:[(0,r.jsx)("input",{type:"checkbox",checked:g,onChange:e=>f(e.target.checked)}),"Remember me"]}),p&&(0,r.jsx)("div",{className:"error",children:p}),(0,r.jsx)("button",{type:"submit",disabled:m,children:m?"Logging inâ€¦":"Login"}),(0,r.jsx)("button",{type:"button",onClick:s,children:"Close"})]})})})}function g(e){let{slides:t=[]}=e,{selectedSlide:s,setSelectedSlide:n}=(0,o.m)();return(0,r.jsx)("div",{className:"slides-panel",children:t.map((e,t)=>(0,r.jsxs)("button",{className:s===t?"active":"",onClick:()=>n(t),children:["Slide ",t+1]},e.id||t))})}function f(e){let{initialText:t=""}=e,[s,n]=(0,i.useState)(t),[o,a]=(0,i.useState)(!1);return(0,r.jsx)("div",{className:"text-layer",contentEditable:o,suppressContentEditableWarning:!0,onClick:()=>a(!0),onBlur:()=>{a(!1)},onInput:e=>n(e.currentTarget.textContent),children:s})}function p(e,t){switch(t.type){case"SET":if(e.present===t.newPresent)return e;return{past:[...e.past,e.present],present:t.newPresent,future:[]};case"UNDO":{if(0===e.past.length)return e;let t=e.past[e.past.length-1];return{past:e.past.slice(0,-1),present:t,future:[e.present,...e.future]}}case"REDO":{if(0===e.future.length)return e;let[t,...s]=e.future;return{past:[...e.past,e.present],present:t,future:s}}default:return e}}function y(e){let[t,s]=(0,i.useReducer)(p,{past:[],present:e,future:[]});return{state:t.present,set:e=>s({type:"SET",newPresent:e}),undo:()=>s({type:"UNDO"}),redo:()=>s({type:"REDO"}),canUndo:t.past.length>0,canRedo:t.future.length>0}}function m(){let e=(0,i.useRef)(!1),t=(0,i.useRef)({x:0,y:0}),{state:s,set:n,undo:o,redo:a,canUndo:l,canRedo:c}=y({x:0,y:0});return(0,r.jsxs)("div",{className:"drag-demo",children:[(0,r.jsx)("div",{className:"draggable",onPointerDown:r=>{e.current=!0,t.current={x:r.clientX-s.x,y:r.clientY-s.y}},onPointerMove:s=>{e.current&&n({x:s.clientX-t.current.x,y:s.clientY-t.current.y})},onPointerUp:()=>{e.current=!1},style:{width:100,height:100,background:"lightblue",position:"absolute",cursor:"move",transform:"translate(".concat(s.x,"px, ").concat(s.y,"px)")}}),(0,r.jsxs)("div",{className:"controls",children:[(0,r.jsx)("button",{onClick:o,disabled:!l,children:"Undo"}),(0,r.jsx)("button",{onClick:a,disabled:!c,children:"Redo"})]})]})}function v(e){let{title:t,children:s}=e,{state:n,set:i,undo:o,redo:a,canUndo:l,canRedo:c}=y(!0);return(0,r.jsxs)("div",{className:"collapsible-group",children:[(0,r.jsxs)("button",{onClick:()=>i(!n),children:[n?"Hide":"Show"," ",t]}),n&&(0,r.jsx)("div",{className:"content",children:s}),(0,r.jsxs)("div",{className:"controls",children:[(0,r.jsx)("button",{onClick:o,disabled:!l,children:"Undo"}),(0,r.jsx)("button",{onClick:a,disabled:!c,children:"Redo"})]})]})}function S(){var e;let t=(0,n.useRouter)(),s=t.query.token,a=t.query.view,{selectedSlide:l,tokenBalance:c}=(0,o.m)(),[u,h]=(0,i.useState)(!1),p=[{id:1,text:"First Slide"},{id:2,text:"Second Slide"}];return(0,r.jsxs)("div",{children:["Editor",s&&(0,r.jsxs)("span",{children:[" Token: ",s]}),a&&(0,r.jsxs)("span",{children:[" View: ",a]}),(0,r.jsxs)("div",{children:["Token Balance: ",c]}),(0,r.jsx)("button",{onClick:()=>h(!0),children:"Login"}),(0,r.jsx)(d,{isOpen:u,onClose:()=>h(!1)}),(0,r.jsx)(v,{title:"Slides",children:(0,r.jsx)(g,{slides:p})}),(0,r.jsx)(f,{initialText:null===(e=p[l])||void 0===e?void 0:e.text}),(0,r.jsx)(m,{})]})}new h},1163:function(e,t,s){e.exports=s(3079)}},function(e){e.O(0,[888,774,179],function(){return e(e.s=4774)}),_N_E=e.O()}]);